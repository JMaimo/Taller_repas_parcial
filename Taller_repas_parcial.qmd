---
title: "Taller evaluado de repaso para el Primer Parcial"
subtitle: "20582- Análisis de Datos para el GMAT"
format:
  html:
    theme: lumen
    toc: true
    toc-depth: 3
Rendering:
    embed-resources: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r, echo=FALSE, eval=FALSE}
library(tidyverse) #Poned aquí todas las librerías que utilicéis
library(readr)
library(MASS) # Per la distància de Mahalanobis
library(ggplot2)
library(dplyr)
library(ggmosaic)
library(Hotelling)
```

Elige un tema que te interese (finanzas, medio ambiente, educación, cine, entre otros). En este taller, aplicarás los pasos del método científico (ver sección 1.1 de los apuntes de la asignatura) para abordar, con datos simulados, una problemática relacionada con el tema elegido. Deberás presentar un informe de tu proyecto siguiendo la estructura detallada en el documento “Recomendaciones para escribir informes de proyectos en Estadística,” que se encuentra en la sección "Práctica" de la página del curso en Aula Digital.

### Primer paso: 
El objetivo general de este trabajo es estudiar algunas características físicas y psicològicas que afectan a la capacidad de anotar puntos de jugadores de voleibol.

Los objetivos más específicos son:
 1. Comprobar si hay una relación con el tiempo de horas dedicadas al entrenamiento afecta al salto máximo vertical o al rendimiento en el partido (evaluado en puntos anotados).
 2. Estudiar la relación de la motivación, la experiencia o el compromiso con la capacidad de puntuar en un partido.

3. Verificar si existen diferencias en el rendimiento entre los jugadores de voleibol en funcion de factores como el sexo o la posición que juegan.

### Segundo paso:

Definiremos 4 variables quantitativas:
X1: horas de entrenamiento semanal.
X2: altura máxima en centimetros alcanzada en un salto veritcal.
X3: velocidad del jugador (segundos en recorrer 20 segundos).
X4: numero de puntuntos anotados en un partido.

3 ordinales (serà una escala del 1 al 5 con niveles desde "Muy bajo" a "Muy alto"):
V1: nivel de compromiso.
V2: nivel de motivación.
V3: nivel de experiencia

Y finalmente 2 variables ordinales: 
Z1: Posición.
Z2: gènero "Masculino" o "Femenino" (són las dos categorías que existen en el mundo del voleibol).


* **Tabla 1**: Genera una tabla con al menos 100 observaciones y las variables definidas en el paso anterior, asegurate que las variables cuantitativas sigan una distribución normal multivariante. A continuación, te presento un ejemplo que simula datos de una encuesta aplicada a estudiantes de secundaria sobre sus hábitos de estudio y rendimiento y que incluye información sobre su contexto de vida, como horas de sueño y tiempo de traslado a la escuela. Este ejemplo no lo debes usar en tu proyecto, solo es para darte una idea de lo que te pido hacer.


```{r}

# Definir la media y la matriz de covarianza para las variables cuantitativas
media <- c(15, 300, 3, 15)  # Medias para horas_entrenamiento, altura_ataque, velocidad, puntos_anotados
covarianza <- matrix(c(10,  1,  1.5, 4,
                       1,   20, 1.2, 3,
                       1.5, 1.2, 0.5, 1,
                       4,   3, 1, 15), 
                     nrow = 4, ncol = 4)

# Generar los datos simulados
set.seed(21)
datos_numericos <- mvrnorm(100, mu = media, Sigma = covarianza)

# Tabla con datos 
rendimiento_voleibol <- data.frame(
  horas_entrenamiento = round(datos_numericos[,1], 1),
  altura_ataque = round(datos_numericos[,2], 1),
  velocidad = round(datos_numericos[,3], 1),
  puntos_anotados = round(datos_numericos[,4]),
  posicion = sample(c("Receptor", "Opuesto", "Central"), 100, replace = TRUE),
  sexo = sample(c("Masculino", "Femenino"), 100, replace = TRUE),
  nivel_compromiso = ordered(sample(1:5, 100, replace = TRUE), labels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto")),
  nivel_motivacion = ordered(sample(1:5, 100, replace = TRUE), labels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto")),
  nivel_experiencia = ordered(sample(1:5, 100, replace = TRUE), labels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto"))
)
rendimiento_voleibol <- as_tibble(rendimiento_voleibol)

```


* **Tabla 2**: Consigue algunos datos en Internet que puedas utilizar para ayudar a resolver tu problema (una variable o dos basta), algunas ideas de dónde buscar son: [datos abiertos del Gobierno de España](https://datos.gob.es/es/), [INE](https://www.ine.es/ss/Satellite?L=0&c=Page&cid=1259942408928&p=1259942408928&pagename=ProductosYServicios%2FPYSLayout), [Kaggle](https://www.kaggle.com/), etc. 


Une ambas tablas utilizando un identificador simulado en una base de datos única. Emplea las funciones del paquete tidyverse explicadas en la sección 1.7.5 de los apuntes de la asignatura. Esta parte es opcional, pero te permitirá enriquecer tu base de datos y realizar análisis más completos.


### Tercer paso

Realiza un análisis descriptivo multivariantes de tu base de datos de acuerdo a los objetivos de tu trabajo. Describe lo observado en el contexto del problema. 
Los objetivos más específicos son:
 1. Comprobar si hay una relación con el tiempo de horas dedicadas al entrenamiento afecta al salto máximo vertical o al rentimiento en el partido (evaluado en puntos anotados).
 2. Estudiar la relación de la motivación, la experiencia o el compromiso con la capacidad de puntuar en un partido.

3. Verificar si existen diferencias en el rendimiento entre los jugadores de voleibol en funcion de factores como el sexo o la posición que juegan.



1. Vamos a hacer un contraste de correlación entre la variable salto veritcal (X2) y el tiempo de horas dedicadas al entrenamiento  (X1). Haremos un test de Pearson ya que teniemos dos variables contínuas que siguen una distribución normal (por construcción) y veremos si existe una correlación lineal.  

```{r}

# Crear un nuevo factor de rangos para las horas de entrenamiento
rendimiento_voleibol$horas_rango <- cut(rendimiento_voleibol$horas_entrenamiento, 
                                        breaks = c(0, 3, 6, 9, 12, 15, 18, 21, 24, 27), 
                                         labels = c("0-3", "3-6", "6-9", "9-12", "12-15", "15-18", "18-21", "21-24", "24-28"))

# Calcular la media de altura de ataque por cada rango de horas de entrenamiento
media_altura_por_rango <- rendimiento_voleibol %>%
  group_by(horas_rango) %>%
  summarise(media_altura = mean(altura_ataque))


# Crear el gráfico de barras
ggplot(media_altura_por_rango, aes(x = horas_rango, y = media_altura, fill = horas_rango)) +
  geom_bar(stat = "identity") +  # Barra de altura proporcional a la media de puntos
  labs(title = "Altura de ataque por rango de horas de entrenamiento",
       x = "Horas de Entrenamiento ", y = "Altura de ataque") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")  + theme(legend.position = "none") 



```



```{r}

cor_test1 <- cor.test(rendimiento_voleibol$horas_entrenamiento, rendimiento_voleibol$altura_ataque)

# Mostrar el resultado
print(cor_test1)

```

No podemos concluir que haya una correlación entre el total de horas entradas a la  semana y la altura de ataque. Puede ser debido a que tiene que ver con la altura del jugador/a, con la genética u otros factores externos. De hecho, como r = 0.0464 indica que casi no hay correlación positiva.


Ahora las horas de entrenamiento con el total de puntos por partido:


```{r}
ggplot(rendimiento_voleibol, aes(x = horas_entrenamiento, y = puntos_anotados)) +
  geom_point(alpha = 0.6) +  # Puntos para observaciones individuales
  stat_smooth(method = "glm", method.args = list(family = "poisson"), 
              color = "blue", se = TRUE) +  # Línea de predicción del modelo de Poisson
  labs(title = "Relación entre Horas de Entrenamiento y Puntos Anotados",
       x = "Horas de Entrenamiento",
       y = "Puntos Anotados") +
  theme_minimal()
```

Si interpretamos la gráfica, vemos como más horas de entrenamiento hay, más puntos parecen anotar, por tanto, podemos intuir que si que hay una correlación entre las dos variables.
```{r}

modelo_poisson <- glm(puntos_anotados ~ horas_entrenamiento, family = "poisson", data = rendimiento_voleibol)

# Resumen del modelo
summary(modelo_poisson)

```
En este caso vemos que el p-valor es menor a 0.05, por tanto podemos rechazar la hipotesis nula. Es decir, sí que hay una correlación entre las horas entrenadas y el total de puntos en un partido. Aunque cabe decir que la correlación no es demasiado fuerte ya que r = 0.278.



2. Vamos a utilizar la prueba de correlación de Spearman para evaluar la relación entre las tres variables ordinales con la variable  de puntos anotados por partido (que podemos considerar continua).

Asignamos valores numericos a las variables ordinales:

```{r}
rendimiento_voleibol
glimpse(rendimiento_voleibol) 

rendimiento_voleibol <- rendimiento_voleibol %>%
  mutate(
    nivel_motivacion = factor(nivel_motivacion, levels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto"),
                              labels = c(1, 2, 3, 4, 5)),
    nivel_experiencia = factor(nivel_experiencia, levels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto"),
                               labels = c(1, 2, 3, 4, 5)),
    nivel_compromiso = factor(nivel_compromiso, levels = c("Muy bajo", "Bajo", "Medio", "Alto", "Muy alto"),
                              labels = c(1, 2, 3, 4, 5)))
  
rendimiento_voleibol <- rendimiento_voleibol %>%
  mutate(
    nivel_motivacion = as.numeric(nivel_motivacion),
    nivel_experiencia = as.numeric(nivel_experiencia),
    nivel_compromiso = as.numeric(nivel_compromiso)
  )

rendimiento_voleibol <- as_tibble(rendimiento_voleibol)

glimpse(rendimiento_voleibol) 

```



```{r}
# Pruebas de correlación de Spearman entre variables ordinales y puntuación
cor_motivacion_puntos <- cor.test(rendimiento_voleibol$nivel_motivacion, rendimiento_voleibol$puntos_anotados, method = "spearman")
cor_experiencia_puntos <- cor.test(rendimiento_voleibol$nivel_experiencia, rendimiento_voleibol$puntos_anotados, method = "spearman")
cor_compromiso_puntos <- cor.test(rendimiento_voleibol$nivel_compromiso, rendimiento_voleibol$puntos_anotados, method = "spearman")

# Resultados
print(cor_motivacion_puntos)
print(cor_experiencia_puntos)
print(cor_compromiso_puntos)

```



```{r}
# Convertir las tres columnas en un formato largo
rendimiento_long <- rendimiento_voleibol %>%
  gather(key = "variable", value = "nivel", 
         nivel_motivacion, nivel_experiencia, nivel_compromiso)

# Crear el gráfico de barras apiladas con facetas
ggplot(rendimiento_long) +
  geom_bar(aes(x = nivel, fill = sexo), position = "stack") +
  facet_wrap(~variable, scales = "free_x") +  # Facetas para cada una de las tres variables
  labs(
    x = "Nivel",
    y = "Número de Jugadores",
    fill = "Sexo",
    title = "Distribución de las características dependido del sexo"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

```








3. Para saber si hay diferencias entre la cantidad de puntos que hace cada jugador segun su posición, haremos una Anova.
```{r}
# Realizamos el ANOVA para comparar los puntos anotados en función de la posición
anova_resultado <- aov(puntos_anotados ~ posicion, data = rendimiento_voleibol)

# Ver el resumen de los resultados del ANOVA
summary(anova_resultado)

```
Observamos que el p-valor es alto, por lo tanto, aceptamos la hipotsesis nula:  Las medias de puntos anotados son iguales para todas las posiciones. Es decir, el total de puntos que hace un jugador por partido no depende de la posición.

Hagamos un gráfico para verlo explícitamente:
```{r}
# Crear un boxplot para visualizar las diferencias de puntos anotados según la posición
ggplot(rendimiento_voleibol, aes(x = posicion, y = puntos_anotados, fill = posicion)) +
  geom_boxplot() +
  labs(title = "Distribución de Puntos Anotados por Posición",
       x = "Posición",
       y = "Puntos Anotados") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")  # Cambia el esquema de colores
```

Vamos a estudiar si el total de puntos que hace un jugador, depende de la categoría que juega (masculino o femenino), para así poder concluir el total de errores y/o bloqueos que se cometen en cada partido dependiendo de la categoria:

```{r}
# Crear un boxplot para visualizar las diferencias de puntos anotados según la posición
ggplot(rendimiento_voleibol, aes(x = sexo, y = puntos_anotados, fill = sexo)) +
  geom_boxplot() +
  labs(title = "Distribución de Puntos Anotados por categoría",
       x = "Categoría",
       y = "Puntos Anotados") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set3")  # Cambia el esquema de colores
```

```{r}
# Realizamos el ANOVA para comparar los puntos anotados en función de la categoría (sexo)
anova_resultado <- aov(puntos_anotados ~ sexo, data = rendimiento_voleibol)

# Ver el resumen de los resultados del ANOVA
summary(anova_resultado)

```



Para las variables cuantitativas de tu base de datos, calcula e interpreta la información que proporciona la varianza generalizada y la varianza total.



### Cuarto paso

Selecciona una de las variables no cuantitativas y modelízala con una distribución multinomial, debes estimar sus parámetros. Utiliza el modelo para calcular la probabilidad de que ocurra un evento de interés en una muestra de tamaño 20, relevante para tu problema.


```{r}

# Calculamos las frecuencias relativas para la variable 'posicion'
tabla_posicion <- rendimiento_voleibol %>%
  count(posicion) %>%
  mutate(probabilidad = n / sum(n))

# Ver los parámetros estimados (probabilidades)
tabla_posicion

# Ahora, modelamos con una distribución multinomial usando las probabilidades estimadas
# Probabilidades estimadas de las categorías
prob_receptor <- tabla_posicion$probabilidad[tabla_posicion$posicion == "Receptor"]
prob_opuesto <- tabla_posicion$probabilidad[tabla_posicion$posicion == "Opuesto"]
prob_central <- tabla_posicion$probabilidad[tabla_posicion$posicion == "Central"]

# Tamaño de la muestra
tamano_muestra <- 20

# Evento de interés: supongamos que nos interesa la probabilidad de tener 10 'Receptor', 5 'Opuesto' y 5 'Central' en una muestra de 20 jugadores
evento_interes <- c(10, 5, 5)

# Aplicamos la fórmula de la distribución multinomial para calcular la probabilidad
probabilidad_evento <- dmultinom(evento_interes, size = tamano_muestra, prob = c(prob_receptor, prob_opuesto, prob_central))

# Mostrar la probabilidad
probabilidad_evento

```





### Quinto paso

Con las variables cuantitativas de tu base de datos, ajusta un modelo de regresión multivariante en la forma:

$$Y=\beta_0+\beta_1 X_1+ \cdots + \beta_p X_p + \epsilon$$
Donde $Y$ es la variable cuantitativa que deseas explicar en función del resto de variables cuantitativas registradas. Además, calcula la función de score e interpreta su resultado en el contexto del problema.

```{r}
# Ajustar el modelo de regresión lineal
modelo <- lm(puntos_anotados ~ horas_entrenamiento + altura_ataque + velocidad, data = rendimiento_voleibol)

# Resumen del modelo para obtener los coeficientes y otras estadísticas
summary(modelo)


# Calcular los residuos
residuos <- residuals(modelo)

head(residuos)

plot(fitted(modelo), residuals(modelo), 
     main = "Gráfico de residuos vs. valores predichos", 
     xlab = "Valores predichos", ylab = "Residuos")
abline(h = 0, col = "red")


```
Si los residuos estuviesn dispersados alrededor del cero, sugerirí que el modelo es adecuado, como no lo estan, no podemos afirmarlo. De echo, vemos que tenemos valores elevados.

En R, la función de score no se calcula directamente como tal, pero se puede observar su comportamiento a través de los residuos del modelo. Para obtener la función de score en regresión lineal, puedes hacerlo indirectamente al calcular los residuos y las derivadas de la log-verosimilitud, o bien, utilizando herramientas más especializadas como optim() o nlm() para maximizar la verosimilitud en modelos más complejos.

### Sexto paso

Realiza un contraste de hipótesis de dos medias multivariante que sea relevante para tu problema. Por ejemplo, podrías evaluar si el vector de medias de la variable cuantitativa de interés $Y$ es el mismo para dos niveles distintos de la variable no cuantitativa que modelaste como multinomial en el paso anterior. Ejecuta el contraste tanto teóricamente como con la función hotelling.test en R. Escribe la conclusión del contraste en el contexto de tu problema.

```{r}
# Seleccionar las variables cuantitativas y la variable sexo
datos_sexo <- rendimiento_voleibol %>%
  dplyr::select(sexo, horas_entrenamiento, altura_ataque, velocidad, puntos_anotados)


# Filtrar los datos por sexo
datos_masculino <- datos_sexo %>% filter(sexo == "Masculino") %>% dplyr::select(-sexo)
datos_femenino <- datos_sexo %>% filter(sexo == "Femenino") %>% dplyr::select(-sexo)

# Realizar la prueba de Hotelling para contrastar las medias multivariantes
# La función hotelling.test toma las dos muestras y compara sus medias multivariantes
test_hotelling <- hotelling.test(datos_masculino, datos_femenino)

# Mostrar el resultado de la prueba
test_hotelling
```

```{r}
# Filtrar los datos de motivación "Muy bajo" y "Muy alto"
datos_motivacion_bajo <- rendimiento_voleibol %>%
  filter(nivel_motivacion == 1) %>%
  dplyr::select(-nivel_motivacion)

datos_motivacion_alto <- rendimiento_voleibol %>%
  filter(nivel_motivacion == 5) %>%
  dplyr::select(-nivel_motivacion)

# Realizar la prueba de Hotelling para comparar las medias multivariantes
test_hotelling <- hotelling.test(datos_motivacion_bajo, datos_motivacion_alto)

# Mostrar el resultado de la prueba
test_hotelling

```


```{r}
# Realizar el contraste MANOVA para varios niveles de motivación
modelo_manova <- manova(cbind(horas_entrenamiento, altura_ataque, velocidad, puntos_anotados) ~ nivel_motivacion, data = rendimiento_voleibol)

# Resumen del modelo MANOVA
summary(modelo_manova)
```



### Último paso

Recuerda que:

* De acuerdo con las recomendaciones para redactar informes de proyectos en Estadística, tu informe debe incluir conclusiones, recomendaciones y bibliografía.

* Crea un repositorio en GitHub para tu proyecto y asegúrate de añadir en el encabezado YAML la siguiente opción necesaria para la renderización sin problemas:


```{r, eval=FALSE}
Rendering:
    embed-resources: true

```

¡Buena suerte y disfruta del proceso!